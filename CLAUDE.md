# Project Guidelines

## Context

The Google Fonts project stores binary font files (.ttf) in the `google/fonts` repository (https://github.com/google/fonts). Each of these files was at some point generated by a font engineer through a compilation process from source project files stored in upstream repositories.

### Terminology

- **google/fonts**: Refers to https://github.com/google/fonts - the main repository containing compiled font binaries
- **upstream repos**: Source repositories containing font project files (`.glyphs`, `.ufo`, `.designspace`, etc.) from which the binary fonts are compiled
- **METADATA.pb**: Protocol buffer files in google/fonts that document font metadata, including the `repository_url` field pointing to upstream repos

### Why Commit Hashes Matter

When fonts are compiled from upstream repos, there is a risk that type designers may have made additional changes after the last time fonts were added or updated in the Google Fonts catalog. Therefore, it is critical to reference the exact commit hashes that were originally used for onboarding.

Any additional work done in upstream repos after the recorded commit will need to go through a separate review and quality assurance process before being incorporated into Google Fonts.

### Goals

1. **Primary goal**: Collect 100% of upstream repository URLs and document them in the corresponding `METADATA.pb` files
2. Verify that `repository_url` fields point to valid repositories
3. Verify that commit hashes in METADATA.pb match the commits originally used for onboarding (not newer commits)
4. Verify that upstream repos have a `config.yaml` file with gftools-builder configuration

### Build Configuration (config.yaml)

Upstream repositories must have a `config.yaml` file containing gftools-builder configuration. The location of this file (relative to the repo root) must be set in the `config_yaml` field inside the `source { ... }` block of `METADATA.pb`.

Alternatively, an overriding `config.yaml` can be provided directly in the family directory within the google/fonts repository.

**Important**: When an override `config.yaml` exists in the google/fonts family directory, the `config_yaml` field can be omitted from the METADATA.pb `source { }` block. The google-fonts-sources tool (used to generate fontc_crater targets) will automatically detect the local override. Only set `config_yaml` in METADATA.pb when pointing to a config file in the upstream repository.

### Fixing Missing or Incorrect Data

When data is missing or incorrect (e.g., missing config.yaml, missing commit hash, wrong repository_url), we should:

1. **Determine correct settings**: Based on investigation of upstream repos, PR history, and font structure
2. **Prepare a PR to google/fonts**: Fix the data directly in google/fonts repository
3. **Use override files when needed**: Since upstream repos may not respond quickly (or at all), we can maintain override `config.yaml` files in google/fonts

PRs to be created are tracked in `data/pending_prs.json` and displayed in the dashboard.

### Validation Strategies

To identify the original onboarding commits, we can use the following approaches:

1. **Check binary file history**: Look at the commit history of the .ttf files in google/fonts to identify the last commit that modified them
2. **Analyze commit messages**: Check if the commit message contains useful information (upstream repo URL, commit hash, PR reference)
3. **Trace linked PRs**: If the commit is linked to a pull request, read the full PR history for additional context and references to upstream sources

### Pending Questions

When there is uncertainty about what actually happened during onboarding, and we need to ask questions to the people involved, save the question to `data/pending_questions.json`. Questions should be grouped by the person (designer or font engineer) best positioned to provide a good answer.

**Important**: Always try to identify a specific person by investigating PR history, commit authors, and repository contributors. Only use generic categories like "Google Fonts team" as a last resort when a specific person truly cannot be identified.

## Upstream Repository Cache (STRICT POLICY)

All upstream repositories must be cloned to `/mnt/shared/upstream_repos/fontc_crater_cache/`.

### Directory Structure

Repositories are organized using the pattern: `{owner}/{repo-name}`

Examples:
- `googlefonts/abeezee`
- `42dot/42dot-Sans`
- `aaronbell/signika`

### Cloning New Repositories

When a new upstream repository URL is discovered (e.g., `https://github.com/owner/repo-name`):

1. **Extract owner and repo name** from the URL
2. **Clone to the correct path**: `/mnt/shared/upstream_repos/fontc_crater_cache/{owner}/{repo-name}`
3. **Do not clone elsewhere** - all upstream repos must be in this centralized location

### Goal

The goal is to have a complete local cache of ALL upstream repositories for fonts in the Google Fonts library. This cache:

- Enables offline analysis and verification
- Speeds up investigations of commit history and build configurations
- Provides a reference for identifying correct onboarding commits

### Finding Missing Repositories

A major ongoing task is to identify upstream repositories that are not yet cloned here. Sources for discovering missing repos include:
- `repository_url` fields in METADATA.pb files in google/fonts
- PR history and commit messages in google/fonts
- Designer portfolio links and GitHub profiles

### Repository Cleanliness (STRICT POLICY)

All repositories in the cache must be:

1. **Clean**: No local uncommitted changes. If a repo has local modifications, they must be reviewed and either:
   - Discarded if they were experimental/temporary
   - Committed and pushed upstream if valuable
   - Reported to the user for manual resolution

2. **Synced**: Up-to-date with their remote origin. Before using a cached repo:
   - Run `git fetch origin` to get latest refs
   - Run `git status` to verify no local changes
   - If behind, run `git pull --ff-only` (fast-forward only to avoid merge commits)

3. **Verified remote**: The git remote URL must be valid and accessible

### Migration from Legacy Directories

The directories `upstream_repos_cache` and `consumed_complementary_cache` were legacy locations used before this policy was established. All repos from these directories have been (or should be) migrated to `fontc_crater_cache` following these steps:

1. Extract `{owner}/{repo-name}` from the git remote URL
2. Verify the repo is clean (no local modifications)
3. Sync with remote (`git fetch && git pull --ff-only`)
4. Move to `/mnt/shared/upstream_repos/fontc_crater_cache/{owner}/{repo-name}`
5. Remove the legacy directory after migration is complete

**Do not use the legacy directories** - they should be empty after migration.

## Google Fonts Repository (STRICT POLICY)

Keep an always up-to-date clone of the `google/fonts` repository at `/mnt/shared/gfonts`.

This repository is used for:
- Reading METADATA.pb files to extract metadata information
- Preparing pull requests to enrich metadata (add repository_url, commit hash, config_yaml)
- Investigating font file history and commit messages

Before any operation that depends on METADATA.pb data, ensure the clone is up-to-date:
```bash
git -C /mnt/shared/gfonts fetch origin && git -C /mnt/shared/gfonts pull --ff-only
```

## Progress Tracking (STRICT POLICY)

### Primary Tracking File

All progress on the documentation effort must be tracked in `data/gfonts_library_sources.json`.

This JSON file contains the status of each font family in the Google Fonts library:
- `family_name`: Name of the font family
- `repository_url`: Upstream repository URL (if known)
- `commit_hash`: Original onboarding commit (if known)
- `config_yaml`: Path to config.yaml (if known)
- `status`: Current status (e.g., "complete", "missing_url", "missing_commit", "needs_investigation")
- `notes`: Any relevant notes or pending questions

**This file is the source of truth** for tracking progress. Keep it always up-to-date.

### Reference Spreadsheet

A reference spreadsheet with prior manual progress is available at:
https://docs.google.com/spreadsheets/d/1ao3k56FwQy6W0Ll5QbU_wpuKEvNPYcn8YyEU9_L8O4Q/edit?gid=0#gid=0

**Important**: The spreadsheet is for reference only and may not be 100% accurate. All information must be validated before being added to the tracking JSON file. Progress must be tracked via `data/gfonts_library_sources.json`, not the spreadsheet.

## Disk Space Monitoring (STRICT POLICY)

Due to limited disk space, monitor usage carefully:

1. **Run `df -h /mnt/shared`** whenever:
   - A new repository is cloned
   - A repository is updated (git pull)
   - Any significant disk operation is performed

2. **Track usage** in the dashboard:
   - Display available disk space
   - Show total upstream repos disk usage
   - Provide a dedicated "Disk Usage" tab on the website

3. **Alert thresholds**:
   - Warning at 95% usage
   - Critical at 98% usage

4. **Minimum free space requirement (STRICT)**:
   - **Refuse to resume work when free disk space is less than 15 GB**
   - Before starting any significant work session, check `df -h /mnt/shared`
   - If available space is below 15 GB, stop and notify the user

5. **Space-saving measures when needed**:
   - Use shallow clones (`--depth 1`) for new repos when full history is not required
   - **NEVER modify upstream repos** - they are the source of truth; do not make commits to them

## Designer Profiles (STRICT POLICY)

When creating or updating designer profile pages, **NEVER mention the "Arctic Code Vault"**. This is a GitHub badge/recognition that is not relevant to font designers' professional profiles and should be omitted entirely.

## Language

All code, comments, documentation, and commit messages must be in English.

## Commit Policy

Make commits frequently, whenever any small progress is achieved. Keep commits granular and atomic.

## Tech Stack

- Static site (HTML, CSS, vanilla JavaScript)
- No build tools or frameworks
- Must be compatible with GitHub Pages

## Message Logging (STRICT POLICY)

All conversation messages must be logged to `data/message_log.json` with timestamp and content. This includes:
- **User messages (role: "user") - MUST be logged verbatim, exactly as written**
- **Assistant messages (role: "assistant") - MUST be logged (summarized is OK, but never omitted)**

**Important**:
- User messages must be preserved word-for-word without any modification or summarization
- Assistant messages must always be logged so the conversation is coherent and readable - summarization is acceptable but complete omission is not
- The log should allow anyone reading it to understand the full context of the conversation

For Portuguese messages, include an English translation in addition to the verbatim original. Append new messages as they are received.

## Friday Status Update

The Friday Status tab provides a weekly status report for the Google Fonts team call. This must be kept always up-to-date with the following criteria:

- **Time window**: Friday 2:00 PM (GMT-3) to the following Friday 1:00 PM (GMT-3)
- **Content**: All significant work accomplished during that week
- **Sections**:
  - What was done this week
  - Planned for next week
  - Questions for the team

The status is automatically extracted from `data/message_log.json` entries within the time window. Ensure all significant accomplishments (PRs created, features implemented, investigations completed) are logged to the message log so they appear in the Friday Status.

## Development

Run locally with `./run.sh` (uses Python's http.server).
